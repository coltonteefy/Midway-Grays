<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Midway Grays</title>

  <!-- Tailwind CSS CDN -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- Font Awesome -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <!-- Inter font -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">

  <!-- Tailwind custom colors -->
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            'primary-blue': {
              DEFAULT: '#256997',
              dark: '#1e537a',
              light: '#4184b2'
            }
          }
        }
      }
    }
  </script>

  <style>
    body { font-family: 'Inter', sans-serif; background-color: #f7fafc; }
    .scroll-hidden::-webkit-scrollbar { display: none; }
    .scroll-hidden { -ms-overflow-style: none; scrollbar-width: none; }

    #search-container.collapsed { max-height: 0; opacity: 0; overflow: hidden; margin-top: 0; }
    #search-container.expanded { max-height: 200px; opacity: 1; margin-top: 1rem; }

    #account-menu.hidden { display: none; }

    #main-nav { transition: all .3s ease-in-out; max-width: 80rem; }
    #main-nav.sticky-scrolled { max-width: none; border-radius: 0; box-shadow: 0 4px 6px -1px rgba(0,0,0,.1), 0 2px 4px -1px rgba(0,0,0,.06); }

    #total-cost-button {
      position: fixed; bottom: 0; left: 0; right: 0; z-index: 40;
      transition: transform .5s cubic-bezier(0.68,-0.55,0.27,1.55);
      transform: translateY(100%);
    }
    #total-cost-button.is-visible { transform: translateY(0); }

    #order-summary-modal {
      position: fixed; top: 0; right: 0; width: 100%; height: 100%;
      max-width: 420px; background-color: #fff; box-shadow: -10px 0 20px rgba(0,0,0,.2);
      z-index: 50; transition: transform .5s cubic-bezier(0.25,0.46,0.45,0.94);
      transform: translateX(100%); display: flex; flex-direction: column;
    }
    #order-summary-modal.is-open { transform: translateX(0); overflow-y: auto; -webkit-overflow-scrolling: touch; }

    #order-summary-list { flex-grow: 1; }

    #cart-backdrop {
      position: fixed; inset: 0; background-color: rgba(0,0,0,.5);
      z-index: 49; opacity: 0; pointer-events: none; transition: opacity .5s ease-out;
    }
    #cart-backdrop.is-open { opacity: 1; pointer-events: auto; }

    .modal-content-scrollable { max-height: 80vh; overflow-y: auto; -webkit-overflow-scrolling: touch; }

    /* Age Gate Loading Animation Styles */
    .vial-container {
      width: 100px; height: 150px; position: relative; display: flex; align-items: flex-end;
    }
    .vial {
      width: 70px; height: 120px; background: #fff; border: 3px solid #333;
      border-bottom-left-radius: 25px; border-bottom-right-radius: 25px;
      position: relative; overflow: hidden;
      box-shadow: 0 0 15px rgba(0, 0, 0, 0.1);
    }
    .vial::before {
      content: ''; position: absolute; top: -30px; left: 50%; transform: translateX(-50%);
      width: 40px; height: 50px; background: #fff; border: 3px solid #333;
      border-bottom: none; border-radius: 10px 10px 0 0;
    }
    .vial::after {
      content: ''; position: absolute; top: -1px; left: 50%; transform: translateX(-50%);
      width: 46px; height: 4px; background: #333; border-radius: 2px; z-index: 2;
    }
    .liquid {
      position: absolute; bottom: 0; left: 0; width: 100%;
      background: #256997; animation: fillVial 2s cubic-bezier(0.25, 0.46, 0.45, 0.94) infinite;
      z-index: 1;
    }
    .bubble {
      position: absolute; bottom: 0; background: #4184b2; border-radius: 50%; opacity: 0;
      animation: bubbleUp 2s cubic-bezier(0.25, 0.46, 0.45, 0.94) infinite;
    }
    @keyframes fillVial { 0% { height: 0; } 100% { height: 100%; } }
    @keyframes bubbleUp {
      0% { transform: translateY(0) scale(0); opacity: 0; }
      50% { opacity: 1; }
      100% { transform: translateY(-100px) scale(1); opacity: 0; }
    }

    /* Button loader styling */
    .button-loader {
      border: 4px solid rgba(255, 255, 255, 0.3);
      border-top-color: #fff;
      border-radius: 50%;
      width: 24px;
      height: 24px;
      animation: spin 1s linear infinite;
    }
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
  </style>
</head>
<body class="bg-gray-100 min-h-screen flex flex-col items-center justify-center relative">

  <!-- Age Gate Modal -->
  <div id="ageGate" class="fixed inset-0 z-50 bg-gray-900 bg-opacity-80 flex items-center justify-center p-4 transition-opacity duration-300 ease-in-out">
    <div class="bg-white rounded-xl shadow-2xl p-8 max-w-xl w-full text-center">
      <!-- Content for the initial age gate prompt -->
      <div id="ageGateContent">
        <div class="mb-6 flex justify-center">
          <img src="https://raw.githubusercontent.com/coltonteefy/inventory/refs/heads/main/MWG_LOGO_3.PNG" alt="Company Logo" class="h-24">
        </div>
        <h2 class="text-2xl font-semibold text-gray-800 mb-6">Are you 21 years of age or older?</h2>
        <div class="flex justify-center space-x-4 mb-6">
          <button id="yesBtn" class="bg-primary-blue text-white font-bold py-3 px-8 rounded-lg shadow-md hover:bg-primary-blue-dark transition-all">Yes</button>
          <button id="noBtn" class="bg-white text-primary-blue font-bold py-3 px-8 rounded-lg shadow-md border-2 border-primary-blue hover:bg-primary-blue hover:text-white transition-all">No</button>
        </div>
        <p class="text-sm text-gray-500 italic">By entering this site, you acknowledge and agree that this site is for research purposes only.</p>
        <div id="rejectionMessage" class="hidden mt-4 p-4 text-center bg-red-100 text-red-700 rounded-lg">
          <p class="font-semibold">Access Denied.</p>
          <p>You must be 21 or older to view this content.</p>
        </div>
      </div>

      <!-- Loading state within the age gate modal -->
      <div id="ageGateLoading" class="hidden flex flex-col items-center justify-center">
        <div class="vial-container">
          <div class="vial">
            <div class="liquid"></div>
            <div class="bubble" style="left: 10%; width: 10px; height: 10px; animation-delay: 0s;"></div>
            <div class="bubble" style="left: 40%; width: 8px; height: 8px; animation-delay: 0.5s;"></div>
            <div class="bubble" style="left: 70%; width: 12px; height: 12px; animation-delay: 1s;"></div>
          </div>
        </div>
        <div class="text-xl font-bold mt-8 text-primary-blue-dark">Preparing Inventory...</div>
      </div>
    </div>
  </div>

  <!-- Main App -->
  <div id="mainContent" class="hidden flex-grow flex flex-col w-full h-full max-w-7xl mx-auto p-4 transition-all">
    <div class="sticky top-0 z-40">
      <nav id="main-nav" class="bg-white shadow-md p-4 w-full flex justify-between items-center h-16 text-primary relative z-40 rounded-xl mb-4">
        <div class="flex-1 flex items-center">
          <img src="https://raw.githubusercontent.com/coltonteefy/inventory/refs/heads/main/MWG_LOGO_3.PNG" alt="Company Logo" class="h-10 sm:h-12 transform scale-[2.0] origin-left">
        </div>
        <div class="flex-grow"></div>
        <div class="flex items-center space-x-2 relative">
          <button id="search-icon-button" class="p-2 text-gray-600 hover:text-gray-900 rounded-full transition duration-300 focus:outline-none focus:ring-2 focus:ring-primary-blue-light" aria-label="Open search">
            <svg class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" aria-hidden="true">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
            </svg>
          </button>
          <button id="account-button" class="flex items-center space-x-2 px-4 py-2 bg-primary-blue text-white font-bold rounded-lg hover:bg-primary-blue-dark transition-colors focus:outline-none focus:ring-2 focus:ring-primary-blue-light text-sm shadow-md">
            <span>Account</span>
            <svg id="dropdown-arrow" class="w-4 h-4 transform transition-transform" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" aria-hidden="true">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
            </svg>
          </button>
          <button id="cartBtn" class="relative text-gray-600 hover:text-primary-blue-dark transition-colors duration-300 ml-4 hidden" aria-label="Cart">
            <i class="fas fa-shopping-cart text-2xl"></i>
            <span id="cartCount" class="absolute -top-2 -right-2 bg-red-500 text-white text-xs font-bold rounded-full h-5 w-5 flex items-center justify-center">0</span>
          </button>
          <div id="account-menu" class="absolute top-full mt-2 w-48 rounded-lg shadow-lg bg-white border border-gray-200 py-1 right-0 z-50 hidden">
            <button id="past-orders-button" class="w-full text-left px-4 py-2 text-sm text-primary hover:bg-gray-100">Past Orders</button>
          </div>
        </div>
      </nav>

      <div id="search-container" class="flex justify-center transition-all duration-300 ease-in-out collapsed">
        <input id="product-search" type="text" placeholder="Search products..." class="w-full px-6 py-4 rounded-full border-2 border-gray-300 text-gray-700 placeholder-gray-500 bg-white focus:outline-none focus:ring-2 focus:ring-primary-blue-light transition-all" aria-label="Product search">
      </div>
    </div>

    <div class="relative w-full mt-8 rounded-xl overflow-hidden">
      <img src="https://raw.githubusercontent.com/coltonteefy/inventory/refs/heads/main/HERO.PNG" alt="Hero section banner showing chemical flasks" class="w-full h-full object-cover">
    </div>

    <main id="productGrid" class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-6 flex-grow pb-8 mt-8"></main>

    <div id="fallbackMessage" class="hidden text-center p-8">
      <h3 class="text-2xl font-bold text-gray-800 mb-2">Site is broken.</h3>
      <p class="text-gray-600">Please come back later.</p>
    </div>
  </div>

  <button id="total-cost-button" class="w-full py-4 bg-orange-500 text-white font-bold text-lg rounded-t-lg shadow-lg hover:bg-orange-600 transition-colors focus:outline-none focus:ring-2 focus:ring-orange-500 flex justify-center items-center px-6">
    <i class="fas fa-shopping-cart mr-4 text-xl" aria-hidden="true"></i><span>View Cart: </span><span id="floating-total-cost">$0.00</span>
  </button>
  <div id="cart-backdrop" class="hidden"></div>

  <div id="order-summary-modal" class="p-8">
    <div class="flex justify-between items-center text-primary mb-4 pb-4 border-b border-gray-200">
      <h2 class="text-2xl font-bold">Your Order</h2>
      <button id="close-order-summary" class="p-2 rounded-full text-gray-500 hover:text-primary-blue-light transition-colors" aria-label="Close cart drawer">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" aria-hidden="true">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
        </svg>
      </button>
    </div>
    <div id="order-summary-list" class="space-y-4">
      <p class="text-center text-gray-500 italic">Your cart is empty.</p>
    </div>
    <div class="mt-auto pt-6 border-t border-gray-200">
      <div class="flex justify-between items-center text-xl font-bold text-primary mb-4">
        <span>Total:</span><span id="order-subtotal">$0.00</span>
      </div>
      <form id="order-form">
        <div class="mb-4">
          <label for="full-name-input" class="block text-gray-500 mb-2">Full Name:</label>
          <input id="full-name-input" type="text" class="w-full p-3 rounded-lg bg-gray-100 border border-gray-300 text-primary focus:outline-none focus:ring-2 focus:ring-primary-blue-light" placeholder="John Doe" required>
        </div>
        <div class="mb-4">
          <label for="email-input" class="block text-gray-500 mb-2">Email for confirmation:</label>
          <input id="email-input" type="email" class="w-full p-3 rounded-lg bg-gray-100 border border-gray-300 text-primary focus:outline-none focus:ring-2 focus:ring-primary-blue-light" placeholder="yourname@example.com" required>
          <p id="email-error" class="text-red-500 text-sm mt-1 hidden">Please enter a valid email address.</p>
        </div>
        <div class="mb-4">
          <label for="phone-input" class="block text-gray-500 mb-2">Phone Number:</label>
          <input id="phone-input" type="tel" class="w-full p-3 rounded-lg bg-gray-100 border border-gray-300 text-primary focus:outline-none focus:ring-2 focus:ring-primary-blue-light" placeholder="555-555-5555" required>
        </div>
        <div class="mb-4">
          <label for="shipping-address-input" class="block text-gray-500 mb-2">Shipping Address:</label>
          <input id="shipping-address-input" type="text" class="w-full p-3 rounded-lg bg-gray-100 border border-gray-300 text-primary focus:outline-none focus:ring-2 focus:ring-primary-blue-light" placeholder="123 Main St" required>
        </div>
        <div class="grid grid-cols-2 gap-4 mb-4">
          <div>
            <label for="city-input" class="block text-gray-500 mb-2">City:</label>
            <input id="city-input" type="text" class="w-full p-3 rounded-lg bg-gray-100 border border-gray-300 text-primary focus:outline-none focus:ring-2 focus:ring-primary-blue-light" placeholder="Anytown" required>
          </div>
          <div>
            <label for="state-input" class="block text-gray-500 mb-2">State:</label>
            <input id="state-input" type="text" class="w-full p-3 rounded-lg bg-gray-100 border border-gray-300 text-primary focus:outline-none focus:ring-2 focus:ring-primary-blue-light" placeholder="State" required>
          </div>
        </div>
        <div class="mb-4">
          <label for="zip-input" class="block text-gray-500 mb-2">ZIP Code:</label>
          <input id="zip-input" type="text" class="w-full p-3 rounded-lg bg-gray-100 border border-gray-300 text-primary focus:outline-none focus:ring-2 focus:ring-primary-blue-light" placeholder="12345" required>
        </div>
        <button id="submit-button" type="submit" class="w-full py-3 bg-primary-blue text-white font-bold rounded-lg hover:bg-primary-blue-dark transition-colors focus:outline-none focus:ring-2 focus:ring-primary-blue-light opacity-50 cursor-not-allowed">
          <!-- The span with the loader will be centered inside the button with flexbox -->
          <span id="button-content" class="flex items-center justify-center">
            <span id="button-text">Submit Order</span>
            <span id="button-loader" class="hidden ml-2">
              <div class="button-loader"></div>
            </span>
          </span>
        </button>
      </form>
      <div id="confirmation-message" class="mt-4 text-center font-semibold hidden"></div>
    </div>
  </div>

  <div id="confirmation-modal" class="fixed inset-0 bg-gray-900 bg-opacity-80 flex items-center justify-center p-4 hidden z-50">
    <div class="bg-white p-8 rounded-xl shadow-2xl max-w-sm w-full text-center border border-gray-200 modal-content-scrollable">
      <h3 class="text-2xl font-bold text-green-600 mb-4">Order Submitted!</h3>
      <p class="text-gray-600 mb-4">Your order has been successfully submitted and is awaiting payment to be processed. An email confirmation with all the details of your order has been sent to the email address you provided.</p>
      <p class="text-gray-600 font-bold mb-4">Order ID: <span id="modal-order-id" class="text-primary"></span></p>
      <div class="bg-red-100 border-l-4 border-red-500 text-red-700 p-4 mb-4 text-left" role="alert">
        <h4 class="font-bold text-lg mb-1">IMPORTANT!</h4>
        <p>This is not a payment. To secure your order, please proceed to the payment options detailed in your confirmation email. Your order will not be fully processed until payment is completed.</p>
      </div>
      <p class="text-gray-600 mb-4">If you don't receive an email within a few minutes, please check your spam or junk folder.</p>
      <p class="text-gray-600 font-bold mb-6">We appreciate your business!</p>
      <button id="modal-close-button" class="w-full py-3 bg-primary-blue text-white font-bold rounded-lg hover:bg-primary-blue-dark transition-colors focus:outline-none focus:ring-2 focus:ring-primary-blue-light">
        Close & Start New Order
      </button>
    </div>
  </div>


  <!-- Firebase SDKs -->
  <script type="module">
    // Firebase v12 modular imports
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-app.js";
    import { getAuth, onAuthStateChanged, signInAnonymously } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-auth.js";
    import { getFirestore, collection, onSnapshot, getDocs, query, limit } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-firestore.js";
    import { getFunctions, httpsCallable } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-functions.js";

    // Firebase configuration
    const firebaseConfig = {
      apiKey: "AIzaSyCWgqGvXzXWBUWd_W-q7uEuARIBZj_JXyI",
      authDomain: "peptide-inventory.firebaseapp.com",
      projectId: "peptide-inventory",
      storageBucket: "peptide-inventory.firebasestorage.app",
      messagingSenderId: "547049240971",
      appId: "1:547049240971:web:83b2e836fee57bb41f578e",
      measurementId: "G-1W58JMJN37"
    };

    // DOM refs
    const ageGate = document.getElementById('ageGate');
    const ageGateContent = document.getElementById('ageGateContent');
    const ageGateLoading = document.getElementById('ageGateLoading');
    const yesBtn = document.getElementById('yesBtn');
    const noBtn = document.getElementById('noBtn');
    const rejectionMessage = document.getElementById('rejectionMessage');
    const mainContent = document.getElementById('mainContent');

    const productGrid = document.getElementById('productGrid');
    const searchIconButton = document.getElementById('search-icon-button');
    const searchContainer = document.getElementById('search-container');
    const productSearchInput = document.getElementById('product-search');
    const accountButton = document.getElementById('account-button');
    const accountMenu = document.getElementById('account-menu');
    const dropdownArrow = document.getElementById('dropdown-arrow');
    const mainNav = document.getElementById('main-nav');

    const totalCostButton = document.getElementById('total-cost-button');
    const floatingTotalCostElement = document.getElementById('floating-total-cost');
    const orderSummaryDrawer = document.getElementById('order-summary-modal');
    const closeOrderSummaryButton = document.getElementById('close-order-summary');
    const cartBackdrop = document.getElementById('cart-backdrop');
    const orderSummaryList = document.getElementById('order-summary-list');
    const orderSubtotalElement = document.getElementById('order-subtotal');

    const orderForm = document.getElementById('order-form');
    const fullNameInput = document.getElementById('full-name-input');
    const emailInput = document.getElementById('email-input');
    const emailError = document.getElementById('email-error');
    const phoneInput = document.getElementById('phone-input');
    const shippingAddressInput = document.getElementById('shipping-address-input');
    const cityInput = document.getElementById('city-input');
    const stateInput = document.getElementById('state-input');
    const zipInput = document.getElementById('zip-input');
    const submitButton = document.getElementById('submit-button');
    const confirmationMessage = document.getElementById('confirmation-message');

    const modalOrderId = document.getElementById('modal-order-id');
    const modalCloseButton = document.getElementById('modal-close-button');
    const confirmationModal = document.getElementById('confirmation-modal');

    const fallbackMessage = document.getElementById('fallbackMessage');
    
    // Button loader DOM elements
    const buttonText = document.getElementById('button-text');
    const buttonLoader = document.getElementById('button-loader');


    // Cart state
    let cart = {};

    // Firebase instances
    let app, db, auth, functions;
    let submitSecureOrder;
    // Get the app ID from the global variable to create the correct path
    const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
    const PRODUCTS_COLLECTION_PATH = 'inventory';
    const productPlaceholder = 'https://raw.githubusercontent.com/coltonteefy/Midway-Grays/refs/heads/main/BLANK_VIAL.jpg';

    // Age Gate
    yesBtn.addEventListener('click', () => {
      ageGateContent.classList.add('hidden');
      ageGateLoading.classList.remove('hidden');
      initFirebaseAndListeners();
      sessionStorage.setItem('isAdult', 'true');
    });
    noBtn.addEventListener('click', () => {
      rejectionMessage.classList.remove('hidden')
    });
    if (sessionStorage.getItem('isAdult') === 'true') {
      ageGate.classList.add('hidden');
      mainContent.classList.remove('hidden');
      initFirebaseAndListeners();
    }

    // Nav interactions
    searchIconButton.addEventListener('click', () => {
      if (searchContainer.classList.contains('collapsed')) {
        searchContainer.classList.remove('collapsed');
        searchContainer.classList.add('expanded');
      } else {
        searchContainer.classList.remove('expanded');
        searchContainer.classList.add('collapsed');
      }
    });
    accountButton.addEventListener('click', () => {
      accountMenu.classList.toggle('hidden');
      dropdownArrow.classList.toggle('rotate-180');
    });
    window.addEventListener('click', (event) => {
      if (!accountButton.contains(event.target) && !accountMenu.contains(event.target)) {
        accountMenu.classList.add('hidden');
        dropdownArrow.classList.remove('rotate-180');
      }
    });
    window.addEventListener('scroll', () => {
      if (window.scrollY > 0) mainNav.classList.add('sticky-scrolled');
      else mainNav.classList.remove('sticky-scrolled');
    });


    // ------------ Firestore Init + Listener (with sanity check) ------------
    let productData = {};

    async function initFirebaseAndListeners() {
      try {
        app = initializeApp(firebaseConfig);
        auth = getAuth(app);
        db = getFirestore(app);
        functions = getFunctions(app, 'us-central1');
        submitSecureOrder = httpsCallable(functions, 'submitSecureOrder');

        // Initial sign-in attempt
        try {
          await signInAnonymously(auth);
        } catch (e) {
        }

        // Wait for auth state change before fetching data
        onAuthStateChanged(auth, (user) => {
          if (user) {
            // Now that we are authenticated, we can listen for data
            const productsColRef = collection(db, PRODUCTS_COLLECTION_PATH);
            onSnapshot(productsColRef, (querySnapshot) => {
              const products = {};
              if (!querySnapshot.empty) {
                querySnapshot.forEach((doc) => { products[doc.id] = doc.data(); });
                productData = products;
                renderProducts(productData);
                ageGate.classList.add('hidden');
                mainContent.classList.remove('hidden');
              } else {
                productGrid.innerHTML = '';
                fallbackMessage.classList.remove('hidden');
                ageGate.classList.add('hidden');
                mainContent.classList.remove('hidden');
              }
            }, (error) => {
              fallbackMessage.innerHTML = `<div class="text-center p-8"><h3 class="text-2xl font-bold text-gray-800 mb-2">Connection Error!</h3><p class="text-gray-600">Could not load products. (Error: ${error.message})</p></div>`;
              fallbackMessage.classList.remove('hidden');
              ageGate.classList.add('hidden');
              mainContent.classList.remove('hidden');
            });
          } else {
            // User is not authenticated, show an error
            fallbackMessage.innerHTML = `<div class="text-center p-8"><h3 class="2xl font-bold text-gray-800 mb-2">Authentication Failed!</h3><p class="text-gray-600">Could not authenticate user. Check your Firebase Authentication setup.</p></div>`;
            fallbackMessage.classList.remove('hidden');
            ageGate.classList.add('hidden');
            mainContent.classList.remove('hidden');
          }
        });
      } catch (error) {
        fallbackMessage.innerHTML = `<div class="text-center p-8"><h3 class="text-2xl font-bold text-gray-800 mb-2">Initialization Error!</h3><p class="text-gray-600">Failed to initialize Firebase. (Error: ${error.message})</p></div>`;
        fallbackMessage.classList.remove('hidden');
        ageGate.classList.add('hidden');
        mainContent.classList.remove('hidden');
      }
    }

    // -------- Rendering, search, and cart logic --------
    const renderProducts = (productsToRender) => {
      productGrid.innerHTML = '';
      fallbackMessage.classList.add('hidden');

      if (Object.keys(productsToRender).length === 0) {
        productGrid.innerHTML = '<p class="text-center text-gray-500 italic">No products found matching your search.</p>';
        return;
      }

      Object.keys(productsToRender).forEach(key => {
        const product = productsToRender[key];
        const isOutOfStock = (product.currentInventory || 0) <= 0;
        const productCard = document.createElement('div');
        productCard.className = `bg-white rounded-xl shadow-lg overflow-hidden flex flex-col items-start p-4 transition-transform duration-300 relative ${isOutOfStock ? 'opacity-70' : ''}`;

        const vialWeight = product.totalVialWeight ? `${product.totalVialWeight}mg` : 'N/A';
        const inventory = (product.currentInventory !== undefined) ? product.currentInventory : 'N/A';
        const priceValue = (product.sellPricePerVial !== undefined) ? product.sellPricePerVial : product.price;
        const priceDisplay = (typeof priceValue === 'number') ? `$${priceValue.toFixed(2)}` : 'Price N/A';

        // Conditional rendering for the "Add to Cart" button and out of stock badge
        let buttonHtml;
        if (isOutOfStock) {
          buttonHtml = `<button class="w-full bg-gray-400 text-white font-bold py-2 rounded-lg cursor-not-allowed" disabled>Out of Stock</button>`;
        } else {
          buttonHtml = `<button class="addToCartBtn w-full bg-primary-blue text-white font-bold py-2 rounded-lg hover:bg-primary-blue-dark transition-colors duration-300" data-product-id="${key}">Add to Cart</button>`;
        }
        
        const outOfStockBadge = isOutOfStock ? `
          <div class="absolute inset-0 bg-gray-900 bg-opacity-50 flex items-center justify-center pointer-events-none">
            <span class="text-white text-xl font-bold tracking-wider uppercase bg-red-600 px-4 py-2 rounded-lg shadow-lg rotate-12">
              Out of Stock
            </span>
          </div>` : '';

        productCard.innerHTML = `
          <div class="relative w-full overflow-hidden rounded-md mb-4">
            <img src="${product.image || ''}" onerror="this.onerror=null;this.src='${productPlaceholder}';" alt="Product Image" class="w-full h-auto object-contain">
            ${outOfStockBadge}
          </div>
          <h3 class="text-xl font-bold text-gray-800">${product.name || key}</h3>
          <p class="text-gray-500 text-sm mt-1">${vialWeight}</p>
          <p class="text-gray-500 text-sm mb-2">Inventory: ${inventory}</p>
          <div class="flex-grow"></div>
          <p class="text-2xl font-bold text-primary-blue-dark mb-4">${priceDisplay}</p>
          ${buttonHtml}
        `;
        productGrid.appendChild(productCard);
      });
    };

    productSearchInput.addEventListener('input', (event) => {
      const searchTerm = event.target.value.toLowerCase();
      if (!searchTerm) return renderProducts(productData);
      const filtered = Object.fromEntries(
        Object.entries(productData).filter(([_, p]) => (p.name || '').toLowerCase().includes(searchTerm))
      );
      renderProducts(filtered);
    });

    productGrid.addEventListener('click', (e) => {
      if (e.target.classList.contains('addToCartBtn')) {
        const productId = e.target.dataset.productId;
        const product = productData[productId];
        if (product && (product.currentInventory || 0) > 0) {
          if (cart[productId]) {
            if (cart[productId].quantity < product.currentInventory) {
              cart[productId].quantity++;
            }
          } else {
            const price = (product.sellPricePerVial !== undefined) ? product.sellPricePerVial : (product.price || 0);
            cart[productId] = { id: productId, name: product.name || 'Item', price, quantity: 1 };
          }
          updateTotalCost();
          renderOrderSummary();
          totalCostButton.classList.add('is-visible');
        }
      }
    });

    function updateTotalCost() {
      const totalCost = Object.values(cart).reduce((sum, item) => sum + (item.price * item.quantity), 0);
      floatingTotalCostElement.textContent = `$${totalCost.toFixed(2)}`;
      if (Object.keys(cart).length > 0) totalCostButton.classList.add('is-visible');
      else totalCostButton.classList.remove('is-visible');
    }

    // Function to check if the form is valid for submission
    function checkFormValidity() {
      // A simple regex to check for a valid email format
      const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
      const isEmailValid = emailRegex.test(emailInput.value.trim());

      // Show or hide the email error message
      if (emailInput.value.trim() !== '' && !isEmailValid) {
        emailError.classList.remove('hidden');
      } else {
        emailError.classList.add('hidden');
      }

      // Check if all input fields have a value AND the email is valid
      const isFormFilledAndValid = fullNameInput.value.trim() !== '' &&
                           isEmailValid &&
                           phoneInput.value.trim() !== '' &&
                           shippingAddressInput.value.trim() !== '' &&
                           cityInput.value.trim() !== '' &&
                           stateInput.value.trim() !== '' &&
                           zipInput.value.trim() !== '';

      // Check if the cart is not empty
      const isCartNotEmpty = Object.keys(cart).length > 0;

      // Enable the button only if both conditions are met
      if (isFormFilledAndValid && isCartNotEmpty) {
        submitButton.removeAttribute('disabled');
        submitButton.classList.remove('opacity-50', 'cursor-not-allowed');
      } else {
        submitButton.setAttribute('disabled', 'disabled');
        submitButton.classList.add('opacity-50', 'cursor-not-allowed');
      }
    }

    function renderOrderSummary() {
      orderSummaryList.innerHTML = '';
      if (Object.keys(cart).length === 0) {
        orderSummaryList.innerHTML = '<p class="text-center text-gray-500 italic">Your cart is empty.</p>';
        orderSubtotalElement.textContent = '$0.00';
        checkFormValidity();
        return;
      }

      let subtotal = 0;

      Object.keys(cart).forEach(productId => {
        const item = cart[productId];
        const itemTotal = item.price * item.quantity;
        subtotal += itemTotal;

        const itemElement = document.createElement('div');
        itemElement.className = 'flex flex-col text-gray-800 border-b border-gray-200 pb-2 last:border-b-0 last:pb-0';
        const itemTotalDisplay = `$${itemTotal.toFixed(2)}`;
        const itemPriceDisplay = `$${item.price.toFixed(2)}`;

        itemElement.innerHTML = `
          <div class="flex justify-between items-center w-full">
            <p class="font-semibold text-lg">${item.name}</p>
            <span class="font-bold shrink-0">${itemTotalDisplay}</span>
          </div>
          <div class="flex justify-between items-center w-full mt-2">
            <p class="text-sm text-gray-500">${itemPriceDisplay} per unit</p>
            <div class="flex items-center space-x-2">
              <button class="cart-btn p-1 rounded-full bg-gray-200 text-gray-800 hover:bg-gray-300 focus:outline-none focus:ring-2 focus:ring-primary-blue-light transition-colors" data-action="decrement" data-product-id="${productId}">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 12H4"/></svg>
              </button>
              <span class="text-lg font-bold w-6 text-center">${item.quantity}</span>
              <button class="cart-btn p-1 rounded-full bg-gray-200 text-gray-800 hover:bg-gray-300 focus:outline-none focus:ring-2 focus:ring-primary-blue-light transition-colors" data-action="increment" data-product-id="${productId}">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"/></svg>
              </button>
              <button class="cart-btn ml-4 text-gray-400 hover:text-red-500 transition-colors focus:outline-none focus:ring-2 focus:ring-red-500 rounded-full p-1" data-action="remove" data-product-id="${productId}">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/></svg>
              </button>
            </div>
          </div>
        `;
        orderSummaryList.appendChild(itemElement);
      });
      orderSubtotalElement.textContent = `$${subtotal.toFixed(2)}`;
      checkFormValidity();
    }

    function resetAppState() {
      cart = {};
      updateTotalCost();
      renderOrderSummary();
      orderForm.reset();
      confirmationModal.classList.add('hidden');
      emailError.classList.add('hidden');
    }

    async function submitOrder(orderData) {
      // Show the button loader and disable the button
      buttonText.classList.add('hidden');
      buttonLoader.classList.remove('hidden');
      submitButton.disabled = true;

      confirmationMessage.textContent = '';
      confirmationMessage.classList.add('hidden');

      try {
        const result = await submitSecureOrder(orderData);
        modalOrderId.textContent = result.data.orderId;
        confirmationModal.classList.remove('hidden');
        orderSummaryDrawer.classList.remove('is-open');
        cartBackdrop.classList.remove('is-open');
      } catch (error) {
        confirmationMessage.textContent = `Failed to submit order: ${error.message}.`;
        confirmationMessage.classList.remove('hidden');
      } finally {
        // Hide the button loader and reset button state
        buttonText.classList.remove('hidden');
        buttonLoader.classList.add('hidden');
        submitButton.disabled = false;
      }
    }

    function attachEventListeners() {
      totalCostButton.addEventListener('click', () => {
        renderOrderSummary();
        orderSummaryDrawer.classList.add('is-open');
        cartBackdrop.classList.remove('hidden');
        cartBackdrop.classList.add('is-open');
      });
      const closeDrawer = () => {
        orderSummaryDrawer.classList.remove('is-open');
        cartBackdrop.classList.remove('is-open');
        cartBackdrop.classList.add('hidden');
      };
      document.getElementById('close-order-summary').addEventListener('click', closeDrawer);
      cartBackdrop.addEventListener('click', closeDrawer);

      orderSummaryDrawer.addEventListener('click', (event) => {
        const target = event.target.closest('.cart-btn');
        if (!target) return;
        const productId = target.dataset.productId;
        if (!cart[productId]) return;

        const action = target.dataset.action;
        const product = productData[productId];

        if (action === 'increment') {
          if (product && cart[productId].quantity < product.currentInventory) {
            cart[productId].quantity++;
          }
        } else if (action === 'decrement') {
          if (cart[productId].quantity > 1) {
            cart[productId].quantity--;
          } else {
            delete cart[productId];
          }
        } else if (action === 'remove') {
          delete cart[productId];
        }

        renderOrderSummary();
        updateTotalCost();
        // Check form validity after every cart change
        checkFormValidity();
      });

      orderForm.addEventListener('submit', (event) => {
        event.preventDefault();

        // Re-check validity before final submission
        checkFormValidity();
        if (submitButton.disabled) {
          // If the button is disabled, something is not valid, so we should not proceed.
          console.warn('Attempted to submit an invalid form.');
          return;
        }

        if (Object.keys(cart).length === 0) {
          console.warn('Attempted to submit empty cart.');
          return;
        }

        const itemsForCloudFunction = Object.values(cart).map(i => ({ id: i.id, quantity: i.quantity }));
        const contactInfo = {
          fullName: fullNameInput.value.trim(),
          email: emailInput.value.trim(),
          phone: phoneInput.value.trim(),
          shippingAddress: `${shippingAddressInput.value.trim()}, ${cityInput.value.trim()}, ${stateInput.value.trim()} ${zipInput.value.trim()}`,
        };
        submitOrder({ items: itemsForCloudFunction, contactInfo });
      });

      modalCloseButton.addEventListener('click', () => {
        resetAppState();
      });

      // Add event listeners to all input fields to check for validity on every change
      [fullNameInput, emailInput, phoneInput, shippingAddressInput, cityInput, stateInput, zipInput].forEach(el => {
        el.addEventListener('input', checkFormValidity);
      });
    }

    window.addEventListener('load', () => {
      attachEventListeners();
      updateTotalCost();
      checkFormValidity(); // Initial check on page load
    });
  </script>
</body>
</html>
